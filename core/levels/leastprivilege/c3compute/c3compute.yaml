imports:
- path: service_account.jinja
- path: cloud_function.jinja
- path: iam_policy.jinja
- path: bucket_acl.jinja
- path: container_vm.jinja


resources:
- name: c3-access
  type: service_account.jinja

- name: c3-check
  type: service_account.jinja

- name: c3-bucket
  type: bucket_acl.jinja
  properties:
    nonce: {{ nonce }}
    predefined_acl: private

- name: c3-instance
  type: ubuntu_vm.jinja
  properties:
    zone: us-west1-b
    open_external: true
    open_http: true
    container_manifest: |
      apiVersion: v1
      kind: Pod
      metadata:
        name: c3
      spec:
        containers:
          - name: c3
            image: docker.io/wwupdx/websec-b2:latest
            imagePullPolicy: Always
            env:
              - name: USERNAME
                value: admin
              - name: PASSWORD
                value: {{secret}}
              - name: PORT
                value: 80

- name: c3-func-access
  type: cloud_function.jinja
  properties:
    region: us-central1
    nonce: {{ nonce }}
    entry_point: main
    upload_url: {{ func_upload_url1 }}
    policyBindings:
    - role: roles/cloudfunctions.invoker
      service_account_id: allusers
    env_variables: {"NONCE":{{nonce}},"RESOURCE_PREFIX":{{prefix}}}

- name: c3-func-check
  type: cloud_function.jinja
  properties:
    region: us-central1
    nonce: {{ nonce }}
    entry_point: main
    upload_url: {{ func_upload_url2 }}
    policyBindings:
    - role: roles/cloudfunctions.invoker
      service_account_id: allusers
    env_variables: {"fvar1":{{fvar1}},"fvar2":{{fvar2}},"NONCE":{{nonce}},"RESOURCE_PREFIX":{{prefix}}} 

- name: iam_policy
  type: iam_policy.jinja
  properties:
    bindings:
    - service_account_id: c3-access
      role:
        name: roles/compute.admin

    - service_account_id: c3-check
      role:
        name: roles/iam.roleViewer
        

